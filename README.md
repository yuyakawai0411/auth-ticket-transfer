# 目次
- 想定したアプリの前提条件
- API仕様
  - 登録されているユーザーを確認するAPI
  - 登録されているイベントを確認するAPI
  - イベント主催者がチケットをユーザーに発券するAPI
  - あるユーザが所有するチケットを確認するAPI
  - ユーザー同士のチケット譲渡機能を行うAPI
  - 誰から譲渡されたチケットかを追跡できるAPI
- その他
  - チケットのステータスを自動で更新するバッチ処理
- 使用方法
  - 事前準備
  - アプリのテスト方法
  - バッチ処理のテスト方法
- 実装した案、実装しなかった案
  - 実装した案
  - 実装しなかった案
  - 今後実装したい機能
- テストに使用した時間
  
**ER図は、ticket_transfer_app.dioに記載しました**
  
# 想定したアプリの前提条件
- アプリ内で金銭的なやり取りは発生しない
- 譲渡機能において、チケットの受け手は譲渡を拒否することができない
- 譲渡の追跡は、自身が所持するチケットが誰から譲渡されたかを確認するために使う
- チケットのステータス(利用可能状況)は、利用不可(status_id=1)→利用可(status_id=2)→期限切れ(status_id=3)の順に推移する

# API仕様
## 登録されているユーザーを確認するAPI
### リクエスト
- HTTP:GET 
- URL:http://users
### レスポンス
- 登録されている全てのユーザー情報
- HTTPステータス200

## 登録されているイベントを確認するAPI
### リクエスト
- HTTP:GET 
- URL:http://events
### レスポンス
- 登録されている全てのイベント情報
- HTTPステータス200

## イベント主催者がチケットをユーザーに発券するAPI
### リクエスト
- HTTP:POST
- URL:http://events/:event_id/tickets
- path:event_id
- body:availability_date, user_id
### レスポンス
- 発券したチケット情報
- HTTPステータス201

## あるユーザが所有するチケットを確認するAPI
### リクエスト
- HTTP:GET 
- URL:http://users/:user_id/tickets
- path:user_id
### レスポンス
- 特定のユーザーが所有している全てのチケット情報
- HTTPステータス200

## ユーザー同士のチケット譲渡機能を行うAPI
### リクエスト
- HTTP:POST
- http://user/:user_id/tickets/:ticket_id/transtions
- path:user_id, ticket_id
- body:receiver_id
### レスポンス
- 譲渡したチケットの名前、送り手、受け手に関する情報
- HTTPステータス201

## 誰から譲渡されたチケットかを追跡できるAPI
### リクエスト
- HTTP:GET
- http://user/:user_id/tickets/:ticket_id/transtions
- path:user_id, ticket_id
### レスポンス
- ユーザーが所有する特定のチケットの譲渡履歴
- HTTPステータス200

# その他
## チケットのステータスを自動で更新するバッチ処理
### 説明
availability_dateと現在の日付を比較し、ステータスを自動で変更します。
当日なら利用可(status_id=2)、過去なら期限切れ(status_id=3)に変更します。

# 使用方法
## 事前準備
1. データベースを作成してください(database.ymlにパスワードが記載されています)
  - `rails db:create`
2. マイグレーションを行なってください
  - `rails db:migrate`
3. サンプルデータをデータベースに保存してください 
  - `rails db:seed`

## アプリのテスト方法
1. 登録されているユーザーのidをAPIで確認してください
2. 登録されているイベントのidをAPIで確認してください
3. 確認したユーザーidとイベントidを元に、APIを使ってチケットをユーザーに発券してください
   - availability_dateはUNIXtimeで記入してください
4. ユーザが所有するチケットをAPIで確認してください
5. ユーザーが所有するチケットを、APIを使って他のユーザーに譲渡してください
   - receiver_idには、譲渡先ユーザーのidを入力してください
6. 譲渡されたチケットは誰から譲渡されたものか、APIで確認してください
   - user_idには、譲渡されたユーザーのidを入力してください

## バッチ処理のテスト方法
1. ticketテーブルに、availability_dateが過去の日付かつstatus_idが1のレコードがあることを確認してください
2. cronにバッチ処理を追加してください(5分毎に処理が行われるため、動作を確認したらすぐに削除してください)
  - `bundle exec whenever --update-crontab`
3. 5分後、先程のレコードのstatus_idが2に更新され、status_transitionsテーブルに更新履歴が追加されていることを確認してください
4. cronに追加したバッチ処理を削除してください 
  - `bundle exec whenever --clear-crontab`


## 実装した案、実装しなかった案
## 実装した案
- イベント主催者がチケットをユーザーに発券するAPI
  - メリット:チケットを購入することができる
  - デメリット:現状、金銭的なやり取りを行うことができない
- チケットのステータスを自動で更新するバッチ処理
  - メリット:チケットのステータスを自動で更新することができる
  - デメリット:現状、日付単位でしかステータスを変更できない
## 実装しなかった案
- ログイン機能
  - メリット:悪意のあるユーザーが他人のチケットを勝手に譲渡できないようにする
  - デメリット:ログイン状態を保持することが難しい(ブラウザのキャッシュ機能等を用いると簡単に実現できる)
- 期限切れのチケットを発券できないようにするバリデーション
  - メリット:イベント主催者が誤って期限切れのチケットを発行しないようにする
  - デメリット:バッチ処理のデモが実現しにくい(チケットステータスの推移に時間がかかる)
## 今後実装したい機能
- 複数のチケットをまとめて譲渡できる機能 
- nullオブジェクトの導入

# テスト実施に使用した時間
- 設計:6h
- コーディング:25h
- リファクタリング:10h

